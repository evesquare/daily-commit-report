name: All Repositories Commit Summary

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate all repositories summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          YEAR=$(date +%Y)
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p daily-report/$YEAR
          
          # æ—¥å ±ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
          REPORT_FILE="daily-report/$YEAR/$TODAY.md"
          
          echo "# All Repositories Commit Summary - $TODAY" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªå…¨ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
          page=1
          has_more=true
          
          while [ "$has_more" = true ]; do
            echo "Fetching repositories page $page..."
            
            # è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªã¨ã‚ªãƒ¼ã‚¬ãƒŠã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
            repos_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/user/repos?type=all&sort=updated&per_page=100&page=$page")
            
            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç©ºé…åˆ—ã‹ãƒã‚§ãƒƒã‚¯
            if [ "$(echo "$repos_response" | jq '. | length')" -eq 0 ]; then
              has_more=false
              continue
            fi
            
            # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…åˆ—ã§ãªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
            if [ "$(echo "$repos_response" | jq -e '. | type' 2>/dev/null)" = "\"array\"" ]; then
              # å„ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
              echo "$repos_response" | jq -r '.[] | "\(.full_name)|\(.private)"' | while IFS='|' read -r repo_name is_private; do
                echo "Checking commits for $repo_name..."
                
                # ä»Šæ—¥ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
                commits_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                  "https://api.github.com/repos/$repo_name/commits?since=${TODAY}T00:00:00Z&until=${TODAY}T23:59:59Z" 2>/dev/null)
                
                # APIã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                if [ $? -eq 0 ] && [ "$(echo "$commits_response" | jq -e '. | type' 2>/dev/null)" = "\"array\"" ]; then
                  commit_count=$(echo "$commits_response" | jq '. | length')
                  
                  if [ "$commit_count" -gt 0 ]; then
                    # ãƒªãƒã‚¸ãƒˆãƒªåã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæƒ…å ±ã‚’å‡ºåŠ›
                    if [ "$is_private" = "true" ]; then
                      echo "## ğŸ”’ $repo_name (Private)" >> $REPORT_FILE
                    else
                      echo "## ğŸ“ $repo_name (Public)" >> $REPORT_FILE
                    fi
                    echo "" >> $REPORT_FILE
                    
                    # ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’æ•´å½¢ã—ã¦å‡ºåŠ›
                    echo "$commits_response" | jq -r '.[] | "- **\(.sha[0:7])** \(.commit.message | split("\n")[0]) (\(.commit.author.name) - \(.commit.author.date | split("T")[0]))"' >> $REPORT_FILE
                    echo "" >> $REPORT_FILE
                  fi
                fi
              done
            else
              echo "Error fetching repositories: $repos_response"
            fi
            
            page=$((page + 1))
            
            # æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if [ "$(echo "$repos_response" | jq '. | length')" -lt 100 ]; then
              has_more=false
            fi
          done
          
          # ã‚ªãƒ¼ã‚¬ãƒŠã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒã‚¸ãƒˆãƒªã‚‚å–å¾—
          orgs_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/user/orgs")
          
          echo "$orgs_response" | jq -r '.[].login' | while read -r org_name; do
            echo "Checking organization: $org_name"
            
            org_page=1
            org_has_more=true
            
            while [ "$org_has_more" = true ]; do
              org_repos_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/orgs/$org_name/repos?type=all&per_page=100&page=$org_page")
              
              if [ "$(echo "$org_repos_response" | jq '. | length')" -eq 0 ]; then
                org_has_more=false
                continue
              fi
              
              if [ "$(echo "$org_repos_response" | jq -e '. | type' 2>/dev/null)" = "\"array\"" ]; then
                echo "$org_repos_response" | jq -r '.[] | "\(.full_name)|\(.private)"' | while IFS='|' read -r repo_name is_private; do
                  echo "Checking commits for $repo_name..."
                  
                  commits_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                    "https://api.github.com/repos/$repo_name/commits?since=${TODAY}T00:00:00Z&until=${TODAY}T23:59:59Z" 2>/dev/null)
                  
                  if [ $? -eq 0 ] && [ "$(echo "$commits_response" | jq -e '. | type' 2>/dev/null)" = "\"array\"" ]; then
                    commit_count=$(echo "$commits_response" | jq '. | length')
                    
                    if [ "$commit_count" -gt 0 ]; then
                      if [ "$is_private" = "true" ]; then
                        echo "## ğŸ”’ $repo_name (Private)" >> $REPORT_FILE
                      else
                        echo "## ğŸ“ $repo_name (Public)" >> $REPORT_FILE
                      fi
                      echo "" >> $REPORT_FILE
                      
                      echo "$commits_response" | jq -r '.[] | "- **\(.sha[0:7])** \(.commit.message | split("\n")[0]) (\(.commit.author.name) - \(.commit.author.date | split("T")[0]))"' >> $REPORT_FILE
                      echo "" >> $REPORT_FILE
                    fi
                  fi
                done
              else
                echo "Error fetching organization repositories: $org_repos_response"
              fi
              
              org_page=$((org_page + 1))
              
              if [ "$(echo "$org_repos_response" | jq '. | length')" -lt 100 ]; then
                org_has_more=false
              fi
            done
          done
          
          # ã‚³ãƒŸãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã®å‡¦ç†
          if [ -f "$REPORT_FILE" ] && [ $(wc -l < "$REPORT_FILE") -le 2 ]; then
            echo "ä»Šæ—¥ã¯ã©ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> $REPORT_FILE
          fi

      - name: Create summary statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # çµ±è¨ˆæƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ 
          TODAY=$(date +%Y-%m-%d)
          YEAR=$(date +%Y)
          REPORT_FILE="daily-report/$YEAR/$TODAY.md"
          
          TOTAL_REPOS=$(grep -c "^## " $REPORT_FILE || echo "0")
          TOTAL_COMMITS=$(grep -c "^- \*\*" $REPORT_FILE || echo "0")
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«çµ±è¨ˆã‚’æ›¸ãè¾¼ã¿
          echo "# All Repositories Commit Summary - $TODAY" > temp-summary.md
          echo "" >> temp-summary.md
          echo "## ğŸ“Š Statistics" >> temp-summary.md
          echo "- **Total repositories with commits:** $TOTAL_REPOS" >> temp-summary.md
          echo "- **Total commits:** $TOTAL_COMMITS" >> temp-summary.md
          echo "" >> temp-summary.md
          echo "---" >> temp-summary.md
          echo "" >> temp-summary.md
          
          # æ—¢å­˜ã®å†…å®¹ã‚’çµ±è¨ˆã®å¾Œã«è¿½åŠ 
          tail -n +3 $REPORT_FILE >> temp-summary.md
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆ
          mv temp-summary.md $REPORT_FILE

      - name: Commit and push changes
        run: |
          TODAY=$(date +%Y-%m-%d)
          YEAR=$(date +%Y)
          REPORT_FILE="daily-report/$YEAR/$TODAY.md"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if [ -f "$REPORT_FILE" ]; then
            git add "$REPORT_FILE"
            if ! git diff --cached --quiet; then
              git commit -m "Add daily commit summary for $TODAY"
              git push
            else
              echo "No changes to commit"
            fi
          fi